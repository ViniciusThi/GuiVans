<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste WebSocket - VansControl</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-radius: 3px;
        }
        .log-info { background: #d1ecf1; }
        .log-success { background: #d4edda; }
        .log-warning { background: #fff3cd; }
        .log-error { background: #f8d7da; }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-wifi"></i> Teste WebSocket - VansControl</h1>
                <p class="text-muted">Ferramenta para testar comunicação WebSocket com ESP32</p>
            </div>
        </div>

        <!-- Status da Conexão -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-signal"></i> Status da Conexão</h5>
                    </div>
                    <div class="card-body">
                        <p>
                            <span id="statusIndicator" class="status-indicator status-disconnected"></span>
                            <span id="statusText">Desconectado</span>
                        </p>
                        <button id="btnConnect" class="btn btn-success me-2">Conectar</button>
                        <button id="btnDisconnect" class="btn btn-danger" disabled>Desconectar</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-microchip"></i> ESP32s Conectados</h5>
                    </div>
                    <div class="card-body">
                        <div id="esp32List">
                            <p class="text-muted">Nenhum ESP32 conectado</p>
                        </div>
                        <button id="btnRefreshESP32" class="btn btn-outline-primary btn-sm">Atualizar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comandos -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Comandos ESP32</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ESP32 ID (opcional)</label>
                            <input type="text" id="esp32Id" class="form-control" placeholder="ESP32_VAN_001">
                            <small class="text-muted">Deixe vazio para enviar para todos</small>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="btnStartAdmin" class="btn btn-warning">Iniciar Modo Admin</button>
                            <button id="btnStopAdmin" class="btn btn-secondary">Parar Modo Admin</button>
                            <button id="btnPingESP32" class="btn btn-info">Ping ESP32</button>
                            <button id="btnGetStatus" class="btn btn-outline-info">Obter Status</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card"></i> Simulação RFID</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">RFID Tag</label>
                            <input type="text" id="rfidTag" class="form-control" placeholder="A1B2C3D4">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fonte</label>
                            <select id="rfidSource" class="form-select">
                                <option value="admin_reading">Leitura Admin</option>
                                <option value="access_control">Controle de Acesso</option>
                            </select>
                        </div>
                        <button id="btnSimulateRFID" class="btn btn-primary w-100">Simular Leitura RFID</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> Log de Eventos</h5>
                        <button id="btnClearLog" class="btn btn-outline-secondary btn-sm">Limpar</button>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isConnected = false;

        // Elementos DOM
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');
        const logContainer = document.getElementById('logContainer');
        const esp32List = document.getElementById('esp32List');

        // Event Listeners
        document.getElementById('btnConnect').addEventListener('click', connect);
        document.getElementById('btnDisconnect').addEventListener('click', disconnect);
        document.getElementById('btnClearLog').addEventListener('click', clearLog);
        document.getElementById('btnRefreshESP32').addEventListener('click', refreshESP32List);
        document.getElementById('btnStartAdmin').addEventListener('click', startAdminMode);
        document.getElementById('btnStopAdmin').addEventListener('click', stopAdminMode);
        document.getElementById('btnPingESP32').addEventListener('click', pingESP32);
        document.getElementById('btnGetStatus').addEventListener('click', getESP32Status);
        document.getElementById('btnSimulateRFID').addEventListener('click', simulateRFID);

        function connect() {
            if (socket) {
                socket.disconnect();
            }

            addLog('Conectando ao servidor...', 'info');
            updateStatus('connecting', 'Conectando...');

            socket = io();

            socket.on('connect', () => {
                isConnected = true;
                updateStatus('connected', 'Conectado');
                addLog('Conectado ao servidor WebSocket', 'success');
                refreshESP32List();
            });

            socket.on('disconnect', () => {
                isConnected = false;
                updateStatus('disconnected', 'Desconectado');
                addLog('Desconectado do servidor', 'warning');
            });

            socket.on('esp32Status', (data) => {
                addLog(`Status ESP32: ${JSON.stringify(data)}`, 'info');
            });

            socket.on('esp32_connected', (data) => {
                addLog(`ESP32 conectado: ${JSON.stringify(data)}`, 'success');
                refreshESP32List();
            });

            socket.on('esp32Disconnected', (data) => {
                addLog(`ESP32 desconectado: ${JSON.stringify(data)}`, 'warning');
                refreshESP32List();
            });

            socket.on('rfidRead', (data) => {
                addLog(`RFID lido: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('esp32List', (data) => {
                updateESP32List(data);
            });

            socket.on('commandError', (data) => {
                addLog(`Erro no comando: ${JSON.stringify(data)}`, 'error');
            });

            socket.on('pong', () => {
                addLog('Pong recebido do servidor', 'info');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function updateStatus(status, text) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
            
            btnConnect.disabled = status === 'connected';
            btnDisconnect.disabled = status !== 'connected';
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            logContainer.innerHTML = '';
        }

        function refreshESP32List() {
            if (socket && isConnected) {
                socket.emit('listESP32s');
            }
        }

        function updateESP32List(esp32s) {
            if (esp32s.length === 0) {
                esp32List.innerHTML = '<p class="text-muted">Nenhum ESP32 conectado</p>';
                return;
            }

            let html = '';
            esp32s.forEach(esp32 => {
                html += `
                    <div class="mb-2 p-2 border rounded">
                        <strong>${esp32.esp32Id}</strong><br>
                        <small class="text-muted">
                            Versão: ${esp32.version || 'N/A'} | 
                            Status: ${esp32.status || 'N/A'} | 
                            Socket: ${esp32.socketId}
                        </small>
                    </div>
                `;
            });
            esp32List.innerHTML = html;
            
            addLog(`${esp32s.length} ESP32(s) conectado(s)`, 'info');
        }

        function startAdminMode() {
            if (!socket || !isConnected) {
                addLog('Não conectado ao servidor', 'error');
                return;
            }

            const esp32Id = document.getElementById('esp32Id').value.trim();
            const command = {
                command: 'startRFIDReading',
                timestamp: new Date(),
                esp32Id: esp32Id || undefined
            };

            if (esp32Id) {
                socket.emit('sendESP32Command', command);
                addLog(`Comando enviado para ESP32 ${esp32Id}: Iniciar modo admin`, 'info');
            } else {
                socket.emit('esp32Command', command);
                addLog('Comando enviado para todos os ESP32s: Iniciar modo admin', 'info');
            }
        }

        function stopAdminMode() {
            if (!socket || !isConnected) {
                addLog('Não conectado ao servidor', 'error');
                return;
            }

            const esp32Id = document.getElementById('esp32Id').value.trim();
            const command = {
                command: 'stopRFIDReading',
                timestamp: new Date(),
                esp32Id: esp32Id || undefined
            };

            if (esp32Id) {
                socket.emit('sendESP32Command', command);
                addLog(`Comando enviado para ESP32 ${esp32Id}: Parar modo admin`, 'info');
            } else {
                socket.emit('esp32Command', command);
                addLog('Comando enviado para todos os ESP32s: Parar modo admin', 'info');
            }
        }

        function pingESP32() {
            if (!socket || !isConnected) {
                addLog('Não conectado ao servidor', 'error');
                return;
            }

            const esp32Id = document.getElementById('esp32Id').value.trim();
            const command = {
                command: 'ping',
                timestamp: new Date(),
                esp32Id: esp32Id || undefined
            };

            if (esp32Id) {
                socket.emit('sendESP32Command', command);
                addLog(`Ping enviado para ESP32 ${esp32Id}`, 'info');
            } else {
                socket.emit('esp32Command', command);
                addLog('Ping enviado para todos os ESP32s', 'info');
            }
        }

        function getESP32Status() {
            if (!socket || !isConnected) {
                addLog('Não conectado ao servidor', 'error');
                return;
            }

            const esp32Id = document.getElementById('esp32Id').value.trim();
            const command = {
                command: 'getStatus',
                timestamp: new Date(),
                esp32Id: esp32Id || undefined
            };

            if (esp32Id) {
                socket.emit('sendESP32Command', command);
                addLog(`Solicitação de status enviada para ESP32 ${esp32Id}`, 'info');
            } else {
                socket.emit('esp32Command', command);
                addLog('Solicitação de status enviada para todos os ESP32s', 'info');
            }
        }

        function simulateRFID() {
            if (!socket || !isConnected) {
                addLog('Não conectado ao servidor', 'error');
                return;
            }

            const rfidTag = document.getElementById('rfidTag').value.trim();
            const source = document.getElementById('rfidSource').value;
            const esp32Id = document.getElementById('esp32Id').value.trim() || 'SIMULATOR';

            if (!rfidTag) {
                addLog('Por favor, insira um RFID Tag', 'error');
                return;
            }

            const data = {
                rfidTag: rfidTag,
                esp32Id: esp32Id,
                source: source,
                timestamp: Date.now(),
                mode: source === 'admin_reading' ? 'administrative' : 'normal'
            };

            socket.emit('rfidRead', data);
            addLog(`RFID simulado: ${rfidTag} (${source})`, 'info');
        }

        // Auto-conectar ao carregar a página
        window.addEventListener('load', () => {
            setTimeout(connect, 500);
        });
    </script>
</body>
</html> 